# お問合せフォーム設計書

## 概要

本ドキュメントは、AIコードレビュー学習サービスにおけるお問い合わせフォーム機能の設計を定義します。

**対象機能**: お問い合わせフォーム（/contact）  
**技術スタック**: Next.js 15 (App Router), MUI, MongoDB, Mongoose, Nodemailer  
**作成日**: 2024-12-06

---

## 1. ユーザーニーズ

### 1.1 なぜこの機能が必要か

お問い合わせフォームは、ユーザーとサービス運営者間のコミュニケーションチャネルとして不可欠です。以下のニーズに対応します：

1. **サービスに関する質問**: 料金プラン、機能の詳細、利用方法についての問い合わせ
2. **技術的なサポート**: エラー報告、バグ報告、機能改善の要望
3. **ビジネスに関する問い合わせ**: 法人利用、パートナーシップ、メディア掲載依頼

### 1.2 使用場面

| 場面 | ユーザー | 内容例 |
|------|---------|--------|
| サービス利用前 | 検討中のユーザー | 「無料プランでどの程度利用できますか？」 |
| サービス利用中 | 登録済みユーザー | 「レビュー結果が表示されません」「この機能を追加してほしい」 |
| ビジネス関連 | 法人・メディア | 「法人契約について相談したい」「取材依頼」 |

### 1.3 期待される効果

- ユーザーからのフィードバック収集によるサービス改善
- 問い合わせの一元管理による運営効率化
- 顧客満足度の向上

---

## 2. 仕様要件

### 2.1 画面仕様

#### 画面構成

```
┌─────────────────────────────────────────┐
│  ヘッダー（ロゴ + 戻るボタン）            │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  アイコン + タイトル             │   │
│  │  「お問い合わせ」                │   │
│  │  サブテキスト                    │   │
│  ├─────────────────────────────────┤   │
│  │  お名前 [________________]       │   │
│  │  メールアドレス [________________]│   │
│  │  件名 [________________]         │   │
│  │  お問い合わせ内容                │   │
│  │  [                              ]│   │
│  │  [                              ]│   │
│  │  [                              ]│   │
│  │  [______________________________]│   │
│  │                                  │   │
│  │  [      送信する      ]          │   │
│  └─────────────────────────────────┘   │
│                                         │
├─────────────────────────────────────────┤
│  フッター（コピーライト）                │
└─────────────────────────────────────────┘
```

#### レスポンシブ対応

| デバイス | 画面幅 | 対応内容 |
|---------|--------|---------|
| モバイル | ~599px | フォーム幅100%、パディング縮小、ロゴテキスト非表示 |
| タブレット | 600-899px | フォーム幅100%、適度なパディング |
| デスクトップ | 900px~ | フォーム幅最大600px、中央配置 |

### 2.2 入力項目

| 項目名 | フィールド名 | 型 | 必須 | 最大文字数 | 備考 |
|-------|-------------|---|------|-----------|------|
| お名前 | name | String | ○ | 100 | 漢字・ひらがな・カタカナ・英数字 |
| メールアドレス | email | String | ○ | 254 | RFC 5321準拠 |
| 件名 | subject | String | ○ | 200 | 自由入力 |
| お問い合わせ内容 | message | String | ○ | 5000 | 複数行テキスト |

### 2.3 バリデーションルール

#### クライアントサイド（リアルタイム）

| 項目 | ルール | エラーメッセージ |
|------|--------|-----------------|
| お名前 | 空欄チェック | 「お名前を入力してください」 |
| お名前 | 最大文字数 | 「お名前は100文字以内で入力してください」 |
| メールアドレス | 空欄チェック | 「メールアドレスを入力してください」 |
| メールアドレス | 形式チェック | 「有効なメールアドレスを入力してください」 |
| 件名 | 空欄チェック | 「件名を入力してください」 |
| 件名 | 最大文字数 | 「件名は200文字以内で入力してください」 |
| お問い合わせ内容 | 空欄チェック | 「お問い合わせ内容を入力してください」 |
| お問い合わせ内容 | 最小文字数 | 「お問い合わせ内容は10文字以上で入力してください」 |
| お問い合わせ内容 | 最大文字数 | 「お問い合わせ内容は5000文字以内で入力してください」 |

#### サーバーサイド（送信時）

- 上記クライアントサイドと同一のバリデーション
- XSS対策（HTMLタグのエスケープ）
- SQLインジェクション対策（Mongooseによるサニタイズ）

### 2.4 メール送信仕様

#### 管理者通知メール

| 項目 | 内容 |
|------|------|
| 宛先 | 環境変数 `ADMIN_EMAIL` |
| 件名 | 「【お問い合わせ】{件名}」 |
| 送信元 | 環境変数 `SMTP_FROM` |
| 形式 | テキスト形式 |

#### メール本文テンプレート

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
AIコードレビュー学習サービス - お問い合わせ通知
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

以下のお問い合わせを受け付けました。

【お名前】
{name}

【メールアドレス】
{email}

【件名】
{subject}

【お問い合わせ内容】
{message}

【受付日時】
{createdAt}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
※このメールは自動送信されています。
```

### 2.5 DB保存仕様

#### コレクション名

`contacts`

#### スキーマ定義

```typescript
{
  name: {
    type: String,
    required: true,
    maxlength: 100
  },
  email: {
    type: String,
    required: true,
    maxlength: 254
  },
  subject: {
    type: String,
    required: true,
    maxlength: 200
  },
  message: {
    type: String,
    required: true,
    maxlength: 5000
  },
  createdAt: {
    type: Date,
    default: Date.now
  },
  status: {
    type: String,
    enum: ['unread', 'read', 'replied'],
    default: 'unread'
  }
}
```

#### インデックス

- `createdAt`: 降順（最新順での取得用）
- `status`: 未読フィルタリング用
- `email`: ユーザー別問い合わせ検索用

---

## 3. 処理手順設計

### 3.1 フロントエンドフロー

```
[ページ読み込み]
    │
    ▼
[フォーム表示]
    │
    ▼
[ユーザー入力] ◄────────────────┐
    │                          │
    ▼                          │
[リアルタイムバリデーション]     │
    │                          │
    ├─ エラーあり ──────────────┘
    │     └── エラーメッセージ表示
    │
    ├─ エラーなし
    │
    ▼
[送信ボタンクリック]
    │
    ▼
[最終バリデーション]
    │
    ├─ エラーあり ──► [エラーメッセージ表示]
    │
    ├─ エラーなし
    │
    ▼
[ローディング状態ON]
[送信ボタン無効化]
    │
    ▼
[API呼び出し POST /api/contact]
    │
    ├─ 成功（200）
    │     │
    │     ▼
    │   [完了メッセージ表示]
    │   [フォームクリア]
    │
    ├─ バリデーションエラー（400）
    │     │
    │     ▼
    │   [エラーメッセージ表示]
    │
    └─ サーバーエラー（500）
          │
          ▼
        [エラーメッセージ表示]
        「送信に失敗しました。時間をおいて再度お試しください。」
```

### 3.2 APIフロー（POST /api/contact）

```
[リクエスト受信]
    │
    ▼
[リクエストボディのパース]
    │
    ├─ パースエラー
    │     └── 400 Bad Request
    │
    ▼
[サーバーサイドバリデーション]
    │
    ├─ バリデーションエラー
    │     └── 400 Bad Request
    │         { success: false, error: "エラーメッセージ" }
    │
    ▼
[MongoDB接続]
    │
    ├─ 接続エラー
    │     └── 500 Internal Server Error
    │
    ▼
[Contactドキュメント作成・保存]
    │
    ├─ 保存エラー
    │     └── 500 Internal Server Error
    │
    ▼
[Nodemailerでメール送信]
    │
    ├─ 送信エラー（ログ記録、処理は継続）
    │
    ▼
[成功レスポンス]
    200 OK
    { success: true, message: "お問い合わせを受け付けました" }
```

### 3.3 エラーハンドリング

| エラー種別 | HTTPステータス | レスポンス | ユーザー向けメッセージ |
|-----------|---------------|-----------|----------------------|
| バリデーションエラー | 400 | `{ success: false, error: "..." }` | 各フィールド下に表示 |
| DB接続エラー | 500 | `{ success: false, error: "サーバーエラー" }` | 「送信に失敗しました。時間をおいて再度お試しください。」 |
| DB保存エラー | 500 | `{ success: false, error: "サーバーエラー" }` | 「送信に失敗しました。時間をおいて再度お試しください。」 |
| メール送信エラー | 200（処理継続） | `{ success: true, ... }` | （ユーザーには通知しない、ログに記録） |

---

## 4. 環境変数

### 4.1 必要な環境変数

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `MONGODB_URI` | MongoDB接続文字列 | `mongodb+srv://user:pass@cluster.mongodb.net/dbname` |
| `ADMIN_EMAIL` | 管理者メールアドレス | `admin@example.com` |
| `SMTP_HOST` | SMTPサーバーホスト | `smtp.gmail.com` |
| `SMTP_PORT` | SMTPポート番号 | `587` |
| `SMTP_SECURE` | TLS使用フラグ | `false`（STARTTLS）または `true`（TLS） |
| `SMTP_USER` | SMTP認証ユーザー | `your-email@gmail.com` |
| `SMTP_PASS` | SMTP認証パスワード | `app-specific-password` |
| `SMTP_FROM` | 送信元メールアドレス | `noreply@example.com` |

### 4.2 .env.local サンプル

```env
# MongoDB
MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/survibe-ai?retryWrites=true&w=majority

# お問い合わせ管理者メール
ADMIN_EMAIL=admin@example.com

# SMTP設定（Gmail例）
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-specific-password
SMTP_FROM=noreply@your-domain.com
```

---

## 5. セキュリティ考慮事項

### 5.1 対策一覧

| 脅威 | 対策 |
|------|------|
| XSS | 入力値のエスケープ、React/Next.jsの自動エスケープ |
| CSRF | Next.js App Routerのビルトイン保護 |
| スパム | レート制限の実装（将来対応）、reCAPTCHA導入（将来対応） |
| 機密情報漏洩 | 環境変数での管理、ログへの機密情報非出力 |

### 5.2 将来的な改善項目

- [ ] reCAPTCHA v3の導入
- [ ] IPベースのレート制限
- [ ] 自動返信メールの実装
- [ ] 管理画面での問い合わせ一覧表示

---

## 6. ファイル構成

```
src/
├── app/
│   ├── contact/
│   │   └── page.tsx          # お問い合わせフォームUI
│   └── api/
│       └── contact/
│           └── route.ts      # APIエンドポイント
├── lib/
│   └── mongodb.ts            # MongoDB接続ユーティリティ
└── models/
    └── Contact.ts            # Mongooseモデル
```

---

## 7. 更新履歴

| 日付 | 更新内容 | 担当 |
|------|---------|------|
| 2024-12-06 | 初版作成 | - |
