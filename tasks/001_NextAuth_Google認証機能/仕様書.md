# NextAuth.js v5 Google認証機能 仕様書

## 1. ユーザーニーズ

### 1.1 なぜこの機能が必要か

- **セキュアなユーザー認証**: パスワード管理の負担を軽減し、Google OAuth 2.0による信頼性の高い認証を提供
- **スムーズなログイン体験**: ワンクリックでGoogleアカウントを使用したログインが可能
- **ユーザー管理基盤**: 将来的な機能拡張（有料プラン、個人設定等）に向けたユーザーデータ管理
- **アクセス制御**: 認証済みユーザーのみがダッシュボード等の保護されたコンテンツにアクセス可能

### 1.2 対象ユーザー

- AIReviewサービスを利用したい開発者
- Googleアカウントを持つユーザー

---

## 2. 仕様要件

### 2.1 認証機能

| 項目 | 内容 |
|------|------|
| 認証方式 | OAuth 2.0 (Google Provider) |
| フレームワーク | NextAuth.js v5 (Auth.js) |
| セッション形式 | JWT (JSON Web Token) |
| ログインURL | `/auth/signin` |
| コールバックURL | `/api/auth/callback/google` |

### 2.2 ユーザーモデル（MongoDB/Mongoose）

```typescript
interface IUser {
  name: string;        // ユーザー名（Google表示名）
  email: string;       // メールアドレス（一意）
  image: string;       // プロフィール画像URL
  role: "user" | "admin";  // ユーザーロール
  createdAt: Date;     // 登録日時
  updatedAt: Date;     // 更新日時
}
```

### 2.3 保護対象ルート

| ルート | 保護レベル | 説明 |
|--------|-----------|------|
| `/dashboard/*` | 認証必須 | ユーザーダッシュボード |
| `/api/user/*` | 認証必須 | ユーザー関連API（将来実装） |

### 2.4 UI要件

#### ヘッダー表示

| 状態 | 表示内容 |
|------|----------|
| 未ログイン | 「ログイン」ボタン |
| ログイン中 | アバター画像、ユーザー名、「ログアウト」ボタン |

#### サインインページ

- Googleログインボタン
- サービス説明テキスト
- 利用規約・プライバシーポリシーへのリンク

#### ダッシュボードページ

- ウェルカムメッセージ（ユーザー名表示）
- ユーザー情報表示
- 今後の機能拡張エリア

### 2.5 環境変数

| 変数名 | 説明 | 必須 |
|--------|------|------|
| `GOOGLE_CLIENT_ID` | Google OAuth クライアントID | ✅ |
| `GOOGLE_CLIENT_SECRET` | Google OAuth クライアントシークレット | ✅ |
| `NEXTAUTH_SECRET` | セッション暗号化キー | ✅ |
| `NEXTAUTH_URL` | アプリケーションURL | ✅ |
| `MONGODB_URI` | MongoDB接続文字列 | ✅（既存） |

---

## 3. 処理手順設計

### 3.1 認証フロー

```
┌─────────────────────────────────────────────────────────────────────┐
│                        認証フローシーケンス                           │
└─────────────────────────────────────────────────────────────────────┘

[ユーザー]          [フロントエンド]        [NextAuth]          [Google]          [MongoDB]
    │                    │                    │                    │                 │
    │  1. ログインクリック │                    │                    │                 │
    │───────────────────>│                    │                    │                 │
    │                    │  2. signIn()       │                    │                 │
    │                    │───────────────────>│                    │                 │
    │                    │                    │  3. OAuth開始      │                 │
    │                    │                    │───────────────────>│                 │
    │                    │                    │                    │                 │
    │  4. Google認証画面 │<────────────────────────────────────────│                 │
    │<───────────────────│                    │                    │                 │
    │                    │                    │                    │                 │
    │  5. 認証許可       │                    │                    │                 │
    │────────────────────────────────────────────────────────────>│                 │
    │                    │                    │                    │                 │
    │                    │                    │  6. トークン返却   │                 │
    │                    │                    │<───────────────────│                 │
    │                    │                    │                    │                 │
    │                    │                    │  7. ユーザー情報保存/更新            │
    │                    │                    │─────────────────────────────────────>│
    │                    │                    │                    │                 │
    │                    │                    │  8. 保存完了       │                 │
    │                    │                    │<─────────────────────────────────────│
    │                    │                    │                    │                 │
    │                    │  9. JWT発行        │                    │                 │
    │                    │<───────────────────│                    │                 │
    │                    │                    │                    │                 │
    │  10. ダッシュボードへリダイレクト        │                    │                 │
    │<───────────────────│                    │                    │                 │
    │                    │                    │                    │                 │
```

### 3.2 ルート保護フロー

```
┌─────────────────────────────────────────────────────────────────────┐
│                      ミドルウェア保護フロー                          │
└─────────────────────────────────────────────────────────────────────┘

[リクエスト] ──> [middleware.ts]
                      │
                      ├── パス確認: /dashboard/* ?
                      │         │
                      │         ├── YES ──> JWT検証
                      │         │              │
                      │         │              ├── 有効 ──> 次へ進む ──> [ページ表示]
                      │         │              │
                      │         │              └── 無効 ──> /auth/signin へリダイレクト
                      │         │
                      │         └── NO ──> 次へ進む ──> [ページ表示]
```

### 3.3 コンポーネント構成図

```
src/
├── app/
│   ├── api/
│   │   └── auth/
│   │       └── [...nextauth]/
│   │           └── route.ts        # NextAuth APIルート
│   ├── auth/
│   │   └── signin/
│   │       └── page.tsx            # サインインページ
│   └── dashboard/
│       └── page.tsx                # ダッシュボード（保護）
│
├── components/
│   └── sections/
│       └── Header.tsx              # 認証状態表示ヘッダー（更新）
│
├── lib/
│   └── mongodb.ts                  # MongoDB接続（既存・変更なし）
│
├── models/
│   ├── Contact.ts                  # お問い合わせモデル（既存・変更なし）
│   └── User.ts                     # ユーザーモデル（新規）
│
├── auth.ts                         # NextAuth.js設定
│
└── middleware.ts                   # ルート保護ミドルウェア

.env.local.example                  # 環境変数テンプレート
```

---

## 4. セキュリティ考慮事項

### 4.1 実装済みセキュリティ対策

- **JWT署名**: NEXTAUTH_SECRETによる署名検証
- **CSRF保護**: NextAuth.js組み込みのCSRFトークン
- **HTTPOnly Cookie**: セッショントークンの安全な保存
- **OAuth 2.0**: Google標準のセキュリティフロー

### 4.2 将来の拡張予定

- ロールベースアクセス制御（RBAC）の詳細実装
- セッション有効期限のカスタマイズ
- リフレッシュトークンの管理

---

## 5. テスト項目

| テストケース | 期待結果 |
|-------------|----------|
| Googleログインボタンクリック | Google認証画面へリダイレクト |
| Google認証成功 | ダッシュボードへリダイレクト |
| 認証キャンセル | サインインページに戻る |
| 未認証で/dashboardアクセス | /auth/signinへリダイレクト |
| ログアウトボタンクリック | セッション終了、トップページへ |
| 新規ユーザーログイン | MongoDBにユーザー作成 |
| 既存ユーザーログイン | MongoDBのユーザー情報更新 |

---

## 6. 実装ファイル一覧

| ファイル | 説明 | 状態 |
|---------|------|------|
| `auth.ts` | NextAuth.js設定 | 新規作成 |
| `src/models/User.ts` | Mongooseユーザーモデル | 新規作成 |
| `middleware.ts` | ルート保護ミドルウェア | 新規作成 |
| `src/app/api/auth/[...nextauth]/route.ts` | NextAuth APIルート | 新規作成 |
| `src/app/auth/signin/page.tsx` | サインインページ | 新規作成 |
| `src/app/dashboard/page.tsx` | ダッシュボードページ | 新規作成 |
| `src/components/sections/Header.tsx` | ヘッダーコンポーネント | 更新 |
| `.env.local.example` | 環境変数テンプレート | 新規作成 |



